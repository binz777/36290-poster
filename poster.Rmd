---
title: "Predicting the Masses of Biggest Cluster Galaxies from their Optical Brightnesses"
author: "Bin, Megha, Athena"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
  html_document:
    theme: spacelab
    toc: yes
    toc_float: yes
---

# Introduction 
Biggest Cluster Galaxies (BCGs) are large collections of galaxies that are studied greatly in astrophysics. More massive objects distort spacetime 
more and will have a larger effect on their environments. In this project, our goal is to determine the relationship between brightness and shapes of 
BCGs and their mass. Finding a direct relationship would allow us to skip intensive computations that have previously been used to predict mass.


# Data
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list=ls())
file.path = "https://raw.githubusercontent.com/pefreeman/36-290/master/PROJECT_DATASETS/SPIDERS_MASS/spiders_bcg_mass.Rdata"
load(url(file.path))
rm(file.path)
objects()

library(tidyverse)
library(MASS)
library(car)
library(rpart)
library(rpart.plot)
library(randomForest)
library(xgboost)
library(FNN)
library(corrplot)
library(leaps)
```

```{r, include = F}
# renaming variables

dff <- data.frame(predictors, response)

dff <- rename(dff, g_modS_CHI2NU = GAL_sdss_g_modS_CHI2NU	,
g_modS_C1_MAG	=	GAL_sdss_g_modS_C1_MAG	,
g_modS_C1_RE	=	GAL_sdss_g_modS_C1_RE	,
g_modS_C1_N	=	GAL_sdss_g_modS_C1_N	,
g_modS_C1_AR	=	GAL_sdss_g_modS_C1_AR	,
g_modS_C1_PA	=	GAL_sdss_g_modS_C1_PA	,
r_modS_CHI2NU	=	GAL_sdss_r_modS_CHI2NU	,
r_modS_C1_MAG	=	GAL_sdss_r_modS_C1_MAG	,
r_modS_C1_RE	=	GAL_sdss_r_modS_C1_RE	,
r_modS_C1_N	=	GAL_sdss_r_modS_C1_N	,
r_modS_C1_AR	=	GAL_sdss_r_modS_C1_AR	,
r_modS_C1_PA	=	GAL_sdss_r_modS_C1_PA	,
i_modS_CHI2NU	=	GAL_sdss_i_modS_CHI2NU	,
i_modS_C1_MAG	=	GAL_sdss_i_modS_C1_MAG	,
i_modS_C1_RE	=	GAL_sdss_i_modS_C1_RE	,
i_modS_C1_N	=	GAL_sdss_i_modS_C1_N	,
i_modS_C1_AR	=	GAL_sdss_i_modS_C1_AR	,
i_modS_C1_PA	=	GAL_sdss_i_modS_C1_PA	,
g_modV_CHI2NU	=	GAL_sdss_g_modV_CHI2NU	,
g_modV_C1_MAG	=	GAL_sdss_g_modV_C1_MAG	,
g_modV_C1_RE	=	GAL_sdss_g_modV_C1_RE	,
g_modV_C1_AR	=	GAL_sdss_g_modV_C1_AR	,
g_modV_C1_PA	=	GAL_sdss_g_modV_C1_PA	,
r_modV_CHI2NU	=	GAL_sdss_r_modV_CHI2NU	,
r_modV_C1_MAG	=	GAL_sdss_r_modV_C1_MAG	,
r_modV_C1_RE	=	GAL_sdss_r_modV_C1_RE	,
r_modV_C1_AR	=	GAL_sdss_r_modV_C1_AR	,
r_modV_C1_PA	=	GAL_sdss_r_modV_C1_PA	,
i_modV_CHI2NU	=	GAL_sdss_i_modV_CHI2NU	,
i_modV_C1_MAG	=	GAL_sdss_i_modV_C1_MAG	,
i_modV_C1_RE	=	GAL_sdss_i_modV_C1_RE	,
i_modV_C1_AR	=	GAL_sdss_i_modV_C1_AR	,
i_modV_C1_PA	=	GAL_sdss_i_modV_C1_PA	,
g_modSX_CHI2NU	=	GAL_sdss_g_modSX_CHI2NU	,
g_modSX_C1_MAG	=	GAL_sdss_g_modSX_C1_MAG	,
g_modSX_C1_RE	=	GAL_sdss_g_modSX_C1_RE	,
g_modSX_C1_N	=	GAL_sdss_g_modSX_C1_N	,
g_modSX_C1_AR	=	GAL_sdss_g_modSX_C1_AR	,
g_modSX_C1_PA	=	GAL_sdss_g_modSX_C1_PA	,
g_modSX_C2_MAG	=	GAL_sdss_g_modSX_C2_MAG	,
g_modSX_C2_RE	=	GAL_sdss_g_modSX_C2_RE	,
g_modSX_C2_AR	=	GAL_sdss_g_modSX_C2_AR	,
g_modSX_C2_PA	=	GAL_sdss_g_modSX_C2_PA	,
r_modSX_CHI2NU	=	GAL_sdss_r_modSX_CHI2NU	,
r_modSX_C1_MAG	=	GAL_sdss_r_modSX_C1_MAG	,
r_modSX_C1_RE	=	GAL_sdss_r_modSX_C1_RE	,
r_modSX_C1_N	=	GAL_sdss_r_modSX_C1_N	,
r_modSX_C1_AR	=	GAL_sdss_r_modSX_C1_AR	,
r_modSX_C1_PA	=	GAL_sdss_r_modSX_C1_PA	,
r_modSX_C2_MAG	=	GAL_sdss_r_modSX_C2_MAG	,
r_modSX_C2_RE	=	GAL_sdss_r_modSX_C2_RE	,
r_modSX_C2_AR	=	GAL_sdss_r_modSX_C2_AR	,
r_modSX_C2_PA	=	GAL_sdss_r_modSX_C2_PA	,
i_modSX_CHI2NU	=	GAL_sdss_i_modSX_CHI2NU	,
i_modSX_C1_MAG	=	GAL_sdss_i_modSX_C1_MAG	,
i_modSX_C1_RE	=	GAL_sdss_i_modSX_C1_RE	,
i_modSX_C1_N	=	GAL_sdss_i_modSX_C1_N	,
i_modSX_C1_AR	=	GAL_sdss_i_modSX_C1_AR	,
i_modSX_C1_PA	=	GAL_sdss_i_modSX_C1_PA	,
i_modSX_C2_MAG	=	GAL_sdss_i_modSX_C2_MAG	,
i_modSX_C2_RE	=	GAL_sdss_i_modSX_C2_RE	,
i_modSX_C2_AR	=	GAL_sdss_i_modSX_C2_AR	,
i_modSX_C2_PA	=	GAL_sdss_i_modSX_C2_PA	)
```
We will analyze data of 390 BCGs from Spectroscopic Identification of eROSITA Sources (SPIDERS), which contains 66 predictor variables including 
measurements of brightness and shape in different bands (g,r,i) and models (S, V, SX).  The response variable that we are interested in predicting is 
the log-base-10 mass of BCGs (logMass).

# EDA 

We performed log transformations on predictor variables related to CHI2NU and RE, which we found yielded better predictions and reduced skewness. 
We also found an overall pattern in the data where many of the predictors, when grouped by a specific property (e.g. MAG) across different models 
and wavelengths were all heavily linearly correlated. This suggests that many of the predictor variables may contain largely redundant information.

```{r, include = F}
# transformations
df <- dff[-c(68, 359), ]

log.chi <- df %>%
  dplyr::select(contains("_CHI")) %>%
  log()

log.re <- df %>%
  dplyr::select(contains("_RE")) %>%
  log()

df <- df %>%
  dplyr::select(-contains(c("_CHI", "_RE")))

df <- data.frame(df, log.chi, log.re)
predictors <- dplyr::select(df, -response)
response <- dplyr::select(df, response)
```
# Regression Analysis

```{r}
set.seed(101)
test.indices = sample(390, 78)
pred.test = predictors[test.indices,]
pred.train = predictors[-test.indices,]
resp.test = response[test.indices]
resp.train = response[-test.indices]
```

```{r}
THRESHOLD = 10
pred.vif = predictors
istop = 0
while ( istop == 0 ) {
  lm.out.update = lm(response~.,data=pred.vif)
  v = vif(lm.out.update)
  if ( max(v) > THRESHOLD ) {
    pred.vif = pred.vif[,-which.max(v)]
  } 
  else {
    istop = 1
  }
}
print(v)
```

```{r}
#LINEAR REGRESSION
#creating data frames based on multicollinearity test 
pred.vif.test = pred.vif[test.indices,]
pred.vif.train = pred.vif[-test.indices,]
resp.vif.test = response[test.indices]
resp.vif.train = response[-test.indices]

lm.mass.vif = lm(resp.vif.train ~ ., data=pred.vif.train)
summary(lm.mass.vif)

#linear regression residual plot
lm.resid_vif= resid(lm.mass.update)
plot(lm.resid_vif[0:350], ylab = "Residuals", xlab= "Mass") + abline(0, 0)

#MSE for linear regression
lm.mass.predict1 = predict(lm.mass.vif, newdata = pred.vif.test)
MSE.lin.vif = mean((resp.vif.test - lm.mass.predict1) ^ 2,na.rm = TRUE)
```

